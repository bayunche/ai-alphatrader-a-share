{
  "location": {
    "module": "App.tsx",
    "related": [
      "services/marketService.ts",
      "server/eastmoney.py"
    ],
    "context": "前端主应用组件负责交易时段判断、行情拉取、持仓补价与搜索；后端 eastmoney.py 也有交易时段判定用于跳过非交易刷新。"
  },
  "current_state": {
    "loops": {
      "main": "useEffect 设置 setInterval 每 60s + 首次 2s 调用 runTradingCycle；非交易时同一关键字仅首开拉一次；进入交易时段重置快照标记。",
      "light_refresh": "marketData 变更后每 15-30s 拉取当前页前 10 只的批量报价，isTradingTimeNow 与 marketHealthy 为前置条件。",
      "pool_cycle": "池内快速刷新在非交易或行情异常时跳过，正常时 15-30s 随机刷新。"
    },
    "health": {
      "agent": "checkModelAvailability 检查 Gemini/OpenAI/Ollama，可用性不满足时阻止启动。",
      "broker": "checkBrokerAvailability 探活真实券商 /health，失败阻止真实模式启动。",
      "market": "marketHealthy/marketError 标记，行情失败时暂停交易与 AI 分析。"
    },
    "risk": "executeTradeForAgent 具备滑点、限价偏离、单次/单标的仓位上限，行情异常直接拒绝下单。",
    "trading_time_fn": "isTradingTimeNow 仅基于本地时间的小时与分钟判断 09:30-11:30、13:00-15:00，未强制使用沪深时区。server/eastmoney.py 使用 datetime.now() 判定，亦依赖系统时区。"
  },
  "tech_stack": {
    "frontend": "Vite + React + TypeScript（主逻辑在 App.tsx）",
    "data_source": "services/marketService.ts 通过后端 /api/market、/quotes，后端市场缓存 12h 过期；失败回退东财/英为。",
    "health": "services/healthService.ts 统一探活模型与券商。"
  },
  "tests": {
    "current": "无前端自动化测试；server 有 eastmoney 判定单元测试。",
    "notes": "未有针对前端交易时段判定的用例；后端判定依赖系统时区，可能与期望不符。"
  },
  "observation": {
    "gaps": [
      "交易时段判定依赖运行时所在时区，若系统时区非 Asia/Shanghai 会导致非交易时间仍判定为交易中，从而继续轮询。",
      "后端 is_trading_time 同样未固定时区，可能与前端判定不一致。"
    ],
    "direction": "需要将交易时段判定统一固定到沪深时区，并确保非交易时快照节流生效。"
  }
}
